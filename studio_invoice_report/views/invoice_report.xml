<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_invoice_document_kof_main" inherit_id="account.report_invoice_document">
        <!-- Remplacer le layout utilisé uniquement pour les factures -->
        <xpath expr="//t[@t-call='web.external_layout']" position="attributes">
            <attribute name="t-call">studio_invoice_report.report_kof_external_layout</attribute>
        </xpath>

        <!-- Remplacer le contenu de la page par une structure qui appelle notre layout personnalisé
             et qui contient ensuite le corps de notre facture.
             Ceci est fait en une seule opération pour éviter les conflits XPath.
        -->
        <xpath expr="//div[contains(@class, 'page')]" position="replace">
            <div class="page">
                <!-- Espaceur pour forcer le contenu vers le bas -->
                <div style="height: 40px;"/>

                <!-- Styles CSS spécifiques au corps de la facture -->
                <style type="text/css">
                    .page {
                        font-family: 'Helvetica', sans-serif;
                        font-size: 14px;
                        color: #333;
                    }
                    .address-section {
                        margin-top: 30px;
                    }
                    .partner-address {
                        text-align: right;
                    }
                    .invoice-title-section {
                        margin-top: 20px;
                    }
                    .invoice-title {
                        font-size: 28px;
                        font-weight: bold;
                        color: #b8641c;
                    }
                    .net-to-pay {
                        text-align: left;
                        border: 1px solid #ddd;
                        padding: 10px;
                        background-color: #f9f9f9;
                    }
                    .net-to-pay h3 {
                        margin: 0;
                        font-size: 14px;
                    }
                    .net-to-pay .amount {
                        font-size: 24px;
                        font-weight: bold;
                        color: #333;
                    }
                    .info-table {
                        margin-top: 10px;
                        width: 100%;
                    }
                    .info-table td {
                        padding: 5px;
                        border: 1px solid #ddd;
                    }
                    .info-table td:first-child {
                        background-color: #f2f2f2;
                        font-weight: bold;
                        width: 35%;
                    }
                    .lines-table {
                        width: 100%;
                        margin-top: 30px;
                        border-collapse: collapse;
                    }
                    .lines-table th {
                        background-color: #b8641c;
                        color: white;
                        padding: 8px;
                    }
                    .lines-table td {
                        padding: 8px;
                        border-bottom: 1px solid #ddd;
                    }
                    .totals-section {
                        margin-top: 20px;
                    }
                    .text-right { text-align: right; }
                    .text-left { text-align: left; }
                    .text-center { text-align: center; }
                </style>

                <!-- Adresse du partenaire -->
                <div class="address-section row">
                    <div class="col-6 offset-6 partner-address">
                        <div style="text-align: right;">
                            <strong>À: <span t-field="o.partner_id.name"/></strong><br/>
                            <span t-field="o.partner_id.street" t-if="o.partner_id.street"/><br t-if="o.partner_id.street"/>
                            <span t-field="o.partner_id.street2" t-if="o.partner_id.street2"/><br t-if="o.partner_id.street2"/>
                            <span t-field="o.partner_id.city" t-if="o.partner_id.city"/>
                            <span t-field="o.partner_id.state_id.name" t-if="o.partner_id.state_id"/>
                            <br t-if="o.partner_id.city or o.partner_id.state_id"/>
                            <span t-field="o.partner_id.country_id.name" t-if="o.partner_id.country_id"/>
                        </div>
                    </div>
                </div>

                <!-- Titre de la facture et Net à payer -->
                <div class="invoice-title-section row">
                    <div class="col-7">
                        <span class="invoice-title">
                            <t t-if="o.move_type == 'out_refund'">Avoir </t>
                            <t t-else="">Facture </t>
                            <span t-field="o.name"/>
                        </span>
                    </div>
                </div>

                <!-- Tableau d'informations -->
                <div class="row">
                    <div class="col-6 net-to-pay">
                        <h3>
                            <t t-if="o.payment_state == 'paid'">
                                <span class="text-success">Payé</span>
                            </t>
                            <t t-elif="o.payment_state == 'not_paid'">
                                <span class="text-danger">Net à payer</span>
                            </t>
                            <t t-elif="o.payment_state == 'in_payment'">
                                <span class="text-warning">Paiement en cours</span>
                            </t>
                            <t t-elif="o.payment_state == 'partial'">
                                <span class="text-warning">Partiellement payé</span>
                            </t>
                            <t t-elif="o.payment_state == 'reversed'">
                                <span class="text-secondary">Contre-passé</span>
                            </t>
                            <t t-elif="o.payment_state == 'invoicing_legacy'">
                                <span class="text-secondary">Ancien module</span>
                            </t>
                            <t t-else="">
                                <span class="text-muted">En attente</span>
                            </t>
                        </h3>
                        <div class="amount">
                            <!-- Affichage conditionnel du montant selon le statut de paiement -->
                            <t t-if="o.payment_state == 'paid'">
                                <span t-field="o.amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                            </t>
                            <t t-elif="o.payment_state == 'partial'">
                                <span t-esc="'{:,.2f} {}'.format(o.amount_total - o.amount_residual, o.currency_id.symbol or '')"/>
                                <br/><small>Restant : <span t-field="o.amount_residual" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></small>
                            </t>
                            <t t-elif="o.payment_state == 'reversed'">
                                <span style="text-decoration: line-through;" t-field="o.amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                <br/><small style="color: red;">Annulé</small>
                            </t>
                            <t t-else="">
                                <span t-field="o.amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                            </t>
                        </div>
                        <!-- <small>Paiement: <span t-field="o.payment_reference"/></small> -->
                    </div>
                    <div class="col-6">
                        <table class="info-table">
                            <tr>
                                <td>Date</td>
                                <td><span t-field="o.invoice_date" t-options='{"format": "dd/MM/yyyy"}'/></td>
                            </tr>
                            <tr>
                                <td>Référence/Description</td>
                                <td><span t-esc="o.narration or ''"/></td>
                            </tr>
                            <tr t-if="o.partner_id.ref">
                                <td>N° du client</td>
                                <td><span t-field="o.partner_id.ref"/></td>
                            </tr>
                            <tr>
                                <td>Date d'échéance</td>
                                <td><span t-field="o.invoice_date_due" t-options='{"format": "dd/MM/yyyy"}'/></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Lignes de facture -->
                <table class="lines-table">
                    <thead>
                        <tr>
                            <th class="text-left">Prestation</th>
                            <th class="text-left">Qte</th>
                            <th class="text-left">Prix unitaire</th>
                            <th class="text-left">Taxe</th>
                            <th class="text-right">Montant</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.invoice_line_ids" t-as="line">
                            <tr t-if="line.display_type == 'product'">
                                <td class="text-left"><span t-esc="(line.name.split(']')[-1]).strip() if line.name and ']' in line.name else (line.name or '').strip()"/></td>
                                <td class="text-left"><span t-field="line.quantity"/></td>
                                <td class="text-left"><span t-field="line.price_unit" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                                <td class="text-left"><span t-esc="', '.join(map(lambda x: x.name, line.tax_ids))"/></td>
                                <td class="text-right"><span t-field="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <!-- Totaux -->
                <div class="totals-section row">
                    <div class="col-6 offset-6">
                        <div id="custom_tax_totals">
                            <!-- Montant hors taxes -->
                            <div class="row">
                                <div class="col-8">
                                    <strong>Montant hors taxes</strong>
                                </div>
                                <div class="col-4 text-end">
                                    <span t-field="o.amount_untaxed" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </div>
                            </div>

                            <!-- Lignes de taxes -->
                            <t t-foreach="o.tax_totals.get('subtotals', [])" t-as="subtotal">
                                <t t-foreach="subtotal.get('tax_groups', [])" t-as="tax_group">
                                    <div class="row mt-1 pt-1" style="border-top: 1px solid #dee2e6;">
                                        <div class="col-8">
                                            <span t-esc="tax_group.get('group_name')"/>
                                        </div>
                                        <div class="col-4 text-end">
                                            <span t-esc="'{:,.2f} {}'.format(tax_group.get('tax_amount', 0), o.currency_id.symbol or '')"/>
                                        </div>
                                    </div>
                                </t>
                            </t>

                            <!-- Montant TTC -->
                            <div class="row mt-2 pt-2 fw-bold" style="border-top: 2px solid black; color: #b8641c;">
                                <div class="col-8">
                                    <span>Montant TTC</span>
                                </div>
                                <div class="col-4 text-end">
                                    <span t-field="o.amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </div>
                            </div>

                            <!-- Section des paiements partiels -->
                            <t t-if="o.payment_state == 'partial'">
                                <t t-set="payment_lines" t-value="o.line_ids.filtered(lambda x: x.account_id.account_type in ('asset_receivable', 'liability_payable') and x.matched_credit_ids)"/>
                                <t t-if="payment_lines">
                                    <div class="row mt-3 pt-2" style="border-top: 1px solid #ddd;">
                                        <div class="col-12">
                                            <strong>Paiements effectués :</strong>
                                        </div>
                                    </div>
                                    <t t-foreach="payment_lines.mapped('matched_credit_ids')" t-as="payment_match">
                                        <div class="row">
                                            <div class="col-8">
                                                <span t-esc="'Payé le ' + payment_match.credit_move_id.date.strftime('%d/%m/%Y')"/>
                                            </div>
                                            <div class="col-4 text-end">
                                                <span t-esc="'{:,.0f} {}'.format(payment_match.amount, o.currency_id.symbol or '')"/>
                                            </div>
                                        </div>
                                    </t>
                                    <div class="row mt-1 pt-1" style="border-top: 1px solid #ddd;">
                                        <div class="col-8">
                                            <strong>Montant dû</strong>
                                        </div>
                                        <div class="col-4 text-end">
                                            <strong><span t-field="o.amount_residual" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></strong>
                                        </div>
                                    </div>
                                </t>
                            </t>
                        </div>
                    </div>
                </div>
                
                <!-- Élément qrcode vide pour éviter les erreurs XPath d'autres templates -->
                <t t-set="show_qr" t-value="o.display_qr_code and o.amount_residual &gt; 0"/>
                <div t-if="not show_qr" name="qr_code_placeholder" class="oe_structure"/>
                <div id="qrcode" class="d-flex mb-3 avoid-page-break-inside" t-else="">
                    <div class="qrcode me-3" id="qrcode_image">
                        <t t-set="qr_code_url" t-value="o._generate_qr_code(silent_errors=True)"/>
                        <p t-if="qr_code_url" class="position-relative mb-0">
                            <img t-att-src="qr_code_url"/>
                            <img src="/account/static/src/img/Odoo_logo_O.svg" id="qrcode_odoo_logo" class="top-50 start-50 position-absolute bg-white border border-white border-3 rounded-circle"/>
                        </p>
                    </div>
                    <div class="d-inline text-muted lh-sm fst-italic" id="qrcode_info" t-if="qr_code_url">
                        <p>Scan this QR Code to<br/>pay with your mobile</p>
                    </div>
                </div>
            </div>
        </xpath>
    </template>
</odoo>
